name: Comment Docs Preview Link

on:
  workflow_run:
    workflows: ["Build Docs (PR Check)"]
    types: [completed]

permissions:
  pull-requests: write
  actions: read

jobs:
  comment:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Download PR number artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-number
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read PR number
        id: pr
        run: echo "number=$(cat pr_number.txt)" >> $GITHUB_OUTPUT

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ steps.pr.outputs.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- docs-build-artifact -->'

      - name: Post artifact link comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ steps.pr.outputs.number }}
          edit-mode: replace
          body: |
            <!-- docs-build-artifact -->
            ## ðŸ“¦ Documentation Build

            | Status | Artifact |
            |--------|----------|
            | âœ… Build successful | [Download docs-build-pr-${{ steps.pr.outputs.number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}) |

            **To preview locally:**
            1. Click the artifact link above
            2. Scroll to "Artifacts" section and download `docs-build-pr-${{ steps.pr.outputs.number }}`
            3. Extract the zip file
            4. Run `npx serve .` in the extracted folder
            5. Open http://localhost:3000

            ---
            <sub>Built from commit ${{ github.event.workflow_run.head_sha }}</sub>
